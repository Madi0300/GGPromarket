import{a as _,w as ue,p as e}from"./chunk-UH6JLGW7-xtm7V6Md.js";import{d as Ae,u as pe,g as he,h as je,i as be}from"./apiSlise-BRduWZpW.js";const ge="_Admin_1pi7j_1",xe="_Admin__page_1pi7j_4",Ne="_Admin__container_1pi7j_9",ve="_Admin__loginPanel_1pi7j_14",fe="_Admin__loginCard_1pi7j_20",ye="_Admin__eyebrow_1pi7j_27",Se="_Admin__loginTitle_1pi7j_34",ke="_Admin__loginDescription_1pi7j_39",we="_Admin__loginForm_1pi7j_44",Ce="_Admin__label_1pi7j_49",Ge="_Admin__input_1pi7j_54",Ie="_Admin__submitButton_1pi7j_68",Be="_Admin__workspace_1pi7j_83",Te="_Admin__header_1pi7j_90",Fe="_Admin__title_1pi7j_96",Ue="_Admin__subtitle_1pi7j_101",Le="_Admin__metaGroup_1pi7j_106",De="_Admin__metaLabel_1pi7j_110",Ee="_Admin__metaValue_1pi7j_117",$e="_Admin__statsGrid_1pi7j_122",Pe="_Admin__statBlock_1pi7j_128",Qe="_Admin__statLabel_1pi7j_134",He="_Admin__statValue_1pi7j_139",Re="_Admin__statHint_1pi7j_144",Oe="_Admin__tabBar_1pi7j_149",Ve="_Admin__tab_1pi7j_149",Me="_Admin__workspaceBody_1pi7j_169",qe="_Admin__sidebar_1pi7j_177",Je="_Admin__sidebarTitle_1pi7j_186",Xe="_Admin__secondaryButton_1pi7j_193",ze="_Admin__sidebarDivider_1pi7j_207",Ke="_Admin__metaBlock_1pi7j_211",We="_Admin__panel_1pi7j_216",Ye="_Admin__panelGrid_1pi7j_223",Ze="_Admin__sectionTitle_1pi7j_229",ei="_Admin__listColumn_1pi7j_234",ii="_Admin__listHint_1pi7j_245",si="_Admin__listItem_1pi7j_250",ni="_Admin__listThumb_1pi7j_266",ai="_Admin__listMeta_1pi7j_273",ti="_Admin__listTitle_1pi7j_278",_i="_Admin__listSubline_1pi7j_282",li="_Admin__listBadge_1pi7j_286",di="_Admin__detailPanel_1pi7j_295",mi="_Admin__uploadRow_1pi7j_305",ci="_Admin__fileInput_1pi7j_310",ri="_Admin__uploadFeedback_1pi7j_318",oi="_Admin__formGrid_1pi7j_332",ui="_Admin__fieldGroup_1pi7j_337",Ai="_Admin__textarea_1pi7j_342",pi="_Admin__switchRow_1pi7j_350",hi="_Admin__actions_1pi7j_357",ji="_Admin__status_1pi7j_362",i={Admin:ge,Admin__page:xe,Admin__container:Ne,Admin__loginPanel:ve,Admin__loginCard:fe,Admin__eyebrow:ye,Admin__loginTitle:Se,Admin__loginDescription:ke,Admin__loginForm:we,Admin__label:Ce,Admin__input:Ge,Admin__submitButton:Ie,Admin__workspace:Be,Admin__header:Te,Admin__title:Fe,Admin__subtitle:Ue,Admin__metaGroup:Le,Admin__metaLabel:De,Admin__metaValue:Ee,Admin__statsGrid:$e,Admin__statBlock:Pe,Admin__statLabel:Qe,Admin__statValue:He,Admin__statHint:Re,Admin__tabBar:Oe,Admin__tab:Ve,"Admin__tab--active":"_Admin__tab--active_1pi7j_164",Admin__workspaceBody:Me,Admin__sidebar:qe,Admin__sidebarTitle:Je,Admin__secondaryButton:Xe,Admin__sidebarDivider:ze,Admin__metaBlock:Ke,Admin__panel:We,Admin__panelGrid:Ye,Admin__sectionTitle:Ze,Admin__listColumn:ei,Admin__listHint:ii,Admin__listItem:si,"Admin__listItem--active":"_Admin__listItem--active_1pi7j_262",Admin__listThumb:ni,Admin__listMeta:ai,Admin__listTitle:ti,Admin__listSubline:_i,Admin__listBadge:li,Admin__detailPanel:di,Admin__uploadRow:mi,Admin__fileInput:ci,Admin__uploadFeedback:ri,"Admin__uploadFeedback--success":"_Admin__uploadFeedback--success_1pi7j_323","Admin__uploadFeedback--error":"_Admin__uploadFeedback--error_1pi7j_326","Admin__uploadFeedback--uploading":"_Admin__uploadFeedback--uploading_1pi7j_329",Admin__formGrid:oi,Admin__fieldGroup:ui,Admin__textarea:Ai,Admin__switchRow:pi,Admin__actions:hi,Admin__status:ji,"Admin__status--error":"_Admin__status--error_1pi7j_367"},U={name:"",href:"#",category:"",country:"",price:"",discount:"",imgUrl:"",rate:"",commentsSum:"",description:"",isHit:!1},L={title:"",imgUrl:"",link:"#"},Ni=ue(function(){var q,J,X,z,K;const[p,D]=_.useState(""),[f,W]=_.useState(""),[b,Y]=_.useState(!1),[E,g]=_.useState(""),[C,Z]=_.useState("goods"),[m,x]=_.useState(null),[r,y]=_.useState(null),[c,l]=_.useState(U),[S,u]=_.useState(L),[G,o]=_.useState(null),[$,I]=_.useState({section:null,state:"idle",message:""}),[ee,ie]=_.useState(""),[B,P]=_.useState(null),A=((q=Ae(null).data)==null?void 0:q.serverUrl)??"",N=pe(null,{skip:!b}),v=he(null,{skip:!b}),k=je(null,{skip:!b}),Q=be(null,{skip:!b}),h=N.data??[],j=v.data??[];_.useEffect(()=>{if(m!=null&&h.length){const s=h.find(n=>n.id===m);if(s){l({name:s.name,href:s.href,category:s.category,country:s.country,price:s.price.toString(),discount:s.discount!=null?s.discount.toString():"",imgUrl:s.imgUrl,rate:s.rate.toString(),commentsSum:s.commentsSum.toString(),description:s.description,isHit:s.isHit});return}}l(U),m!=null&&x(null)},[m,h]),_.useEffect(()=>{if(r!=null&&j.length){const s=j.find(n=>n.id===r);if(s){u({title:s.title,imgUrl:s.imgUrl,link:s.link});return}}u(L),r!=null&&y(null)},[r,j]);const se=_.useMemo(()=>{var s;return[{label:"Товары",value:N.isLoading?"...":h.length,hint:"Записей в каталоге"},{label:"Бренды",value:k.isLoading?"...":((s=k.data)==null?void 0:s.length)??0,hint:"Партнёров на витрине"},{label:"Статьи",value:v.isLoading?"...":j.length,hint:"Публикаций в блоге"}]},[h.length,N.isLoading,(J=k.data)==null?void 0:J.length,k.isLoading,j.length,v.isLoading]),H=async(s,n,t)=>{if(!A)throw new Error("Не удалось определить адрес API.");if(!f)throw new Error("Сначала подтвердите код администратора.");const a=await fetch(`${A}/api${s}`,{method:n,headers:{"Content-Type":"application/json","X-ADMIN-CODE":f},body:JSON.stringify(t)}),d=await a.json().catch(()=>({}));if(!a.ok)throw new Error((d==null?void 0:d.message)||"Ошибка сервера");return d},ne=async s=>{if(!A)throw new Error("Не удалось определить адрес API.");if(!f)throw new Error("Сначала подтвердите код администратора.");const n=new FormData;n.append("image",s);const t=await fetch(`${A}/api/admin/upload`,{method:"POST",headers:{"X-ADMIN-CODE":f},body:n}),a=await t.json().catch(()=>({}));if(!t.ok)throw new Error((a==null?void 0:a.message)||"Не удалось загрузить изображение.");return a},R=async(s,n)=>{if(s){I({section:n,state:"uploading",message:"Загрузка изображения..."});try{const t=await ne(s),a=(t==null?void 0:t.path)??(t==null?void 0:t.url)??"";if(!a)throw new Error("Адрес изображения не получен.");n==="goods"?l(d=>({...d,imgUrl:a})):u(d=>({...d,imgUrl:a})),n==="goods"&&!B&&P(a),I({section:n,state:"success",message:"Изображение успешно загружено."})}catch(t){I({section:n,state:"error",message:t instanceof Error?t.message:"Не удалось загрузить файл."})}}},O=s=>$.section===s?$:null,T=O("goods"),F=O("articles"),ae=async s=>{if(s.preventDefault(),g(""),!A){g("Сервер ещё не ответил, обновите страницу.");return}try{const n=await fetch(`${A}/api/admin/check-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:p.trim()})}),t=await n.json().catch(()=>({}));if(n.ok&&t.valid){W(p.trim()),Y(!0),D(""),g(""),o({type:"success",message:"Доступ подтверждён. Вы в админке."});return}g(t.message||"Неверный секретный код.")}catch(n){console.error(n),g("Не удалось проверить код. Попробуйте ещё раз.")}},te=async s=>{s.preventDefault(),o(null);const n=m?"PUT":"POST",t=m?`/admin/goods/${m}`:"/admin/goods";try{const a=await H(t,n,c),d=m?"Товар обновлён":`Товар добавлен (ID ${(a==null?void 0:a.id)??"?"})`;o({type:"success",message:d}),N.refetch(),!m&&(a!=null&&a.id)&&x(Number(a.id))}catch(a){o({type:"error",message:a.message})}},_e=async s=>{s.preventDefault(),o(null);const n=r?"PUT":"POST",t=r?`/admin/articles/${r}`:"/admin/articles";try{await H(t,n,S),o({type:"success",message:r?"Статья обновлена":"Статья опубликована"}),v.refetch()}catch(a){o({type:"error",message:a.message})}},le=s=>{if(m===s){x(null);return}x(s)},de=s=>{if(r===s){y(null);return}y(s)},V=()=>{x(null),l(U)},M=()=>{y(null),u(L)},me=s=>{ie(s.target.value)},ce=s=>{var a;const n=(a=s.target.files)==null?void 0:a[0];if(!n)return;const t=new FileReader;t.onloadend=()=>{const d=t.result;typeof d=="string"&&P(d)},t.readAsDataURL(n)},re=()=>N.isLoading?e.jsx("p",{className:i.Admin__listHint,children:"Загружаем товары..."}):h.map(s=>e.jsxs("button",{type:"button",className:`${i.Admin__listItem} ${m===s.id?i["Admin__listItem--active"]:""}`,onClick:()=>le(s.id),children:[e.jsx("img",{src:s.imgUrl,alt:s.name,className:i.Admin__listThumb}),e.jsxs("div",{className:i.Admin__listMeta,children:[e.jsx("div",{className:i.Admin__listTitle,children:s.name}),e.jsxs("div",{className:i.Admin__listSubline,children:["#",s.id," • ",s.category," • ",s.country]})]}),e.jsxs("div",{className:i.Admin__listBadge,children:[e.jsxs("span",{children:[s.price.toLocaleString()," ₽"]}),s.discount&&s.discount<s.price?e.jsxs("small",{children:["акция ",s.discount.toLocaleString()," ₽"]}):null]})]},s.id)),oe=()=>v.isLoading?e.jsx("p",{className:i.Admin__listHint,children:"Загружаем статьи..."}):j.map(s=>e.jsxs("button",{type:"button",className:`${i.Admin__listItem} ${r===s.id?i["Admin__listItem--active"]:""}`,onClick:()=>de(s.id),children:[e.jsxs("div",{className:i.Admin__listMeta,children:[e.jsx("div",{className:i.Admin__listTitle,children:s.title}),e.jsxs("div",{className:i.Admin__listSubline,children:["#",s.id]})]}),e.jsx("div",{className:i.Admin__listBadge,children:e.jsx("span",{children:s.link||"—"})})]},s.id));return e.jsx("main",{className:i.Admin__page,children:e.jsx("div",{className:i.Admin__container,children:b?e.jsxs("section",{className:i.Admin__workspace,children:[e.jsxs("header",{className:i.Admin__header,children:[e.jsxs("div",{children:[e.jsx("p",{className:i.Admin__eyebrow,children:"Суперпанель"}),e.jsx("h1",{className:i.Admin__title,children:"Управление контентом"}),e.jsx("p",{className:i.Admin__subtitle,children:((X=Q.data)==null?void 0:X.title)||"SEO-заголовок пока не загружен"})]}),e.jsxs("div",{className:i.Admin__metaGroup,children:[e.jsxs("div",{children:[e.jsx("p",{className:i.Admin__metaLabel,children:"API"}),e.jsx("p",{className:i.Admin__metaValue,children:A||"..."})]}),e.jsxs("div",{children:[e.jsx("p",{className:i.Admin__metaLabel,children:"Статус доступа"}),e.jsx("p",{className:i.Admin__metaValue,children:"Разрешён"})]})]})]}),e.jsx("div",{className:i.Admin__statsGrid,children:se.map(s=>e.jsxs("article",{className:i.Admin__statBlock,children:[e.jsx("p",{className:i.Admin__statLabel,children:s.label}),e.jsx("p",{className:i.Admin__statValue,children:s.value}),e.jsx("p",{className:i.Admin__statHint,children:s.hint})]},s.label))}),e.jsx("div",{className:i.Admin__tabBar,children:[{key:"goods",label:"Каталог товаров"},{key:"articles",label:"Блог и статьи"}].map(s=>e.jsx("button",{type:"button",className:`${i.Admin__tab} ${C===s.key?i["Admin__tab--active"]:""}`,onClick:()=>{Z(s.key),o(null)},children:s.label},s.key))}),e.jsxs("div",{className:i.Admin__workspaceBody,children:[e.jsxs("aside",{className:i.Admin__sidebar,children:[e.jsxs("div",{className:i.Admin__sidebarBlock,children:[e.jsx("p",{className:i.Admin__sidebarLabel,children:"Изменяемый блок"}),e.jsx("label",{className:i.Admin__sidebarLabel,children:"Текст блока"}),e.jsx("textarea",{className:i.Admin__sidebarTextarea,value:ee,onChange:me}),e.jsx("label",{className:i.Admin__sidebarLabel,children:"Фон-изображение"}),e.jsx("input",{className:i.Admin__sidebarImageInput,type:"file",accept:"image/*",onChange:ce}),B?e.jsx("div",{className:i.Admin__sidebarImagePreview,children:e.jsx("img",{src:B,alt:"Превью блока",className:i.Admin__sidebarImage})}):null]}),e.jsx("div",{className:i.Admin__sidebarDivider}),e.jsx("p",{className:i.Admin__sidebarTitle,children:"Действия"}),e.jsx("button",{type:"button",className:i.Admin__secondaryButton,onClick:C==="goods"?V:M,children:"+ Создать новую запись"}),e.jsx("div",{className:i.Admin__sidebarDivider}),e.jsxs("div",{className:i.Admin__metaBlock,children:[e.jsx("p",{className:i.Admin__metaLabel,children:"SEO-текст"}),e.jsxs("p",{className:i.Admin__metaValue,children:[((K=(z=Q.data)==null?void 0:z.text)==null?void 0:K.slice(0,120))||"Описание пока не загружено","…"]})]})]}),e.jsxs("div",{className:i.Admin__panel,children:[G?e.jsx("div",{className:`${i.Admin__status} ${G.type==="error"?i["Admin__status--error"]:i["Admin__status--success"]}`,children:G.message}):null,C==="goods"?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:i.Admin__sectionTitle,children:"Каталог товаров"}),e.jsxs("div",{className:i.Admin__panelGrid,children:[e.jsx("div",{className:i.Admin__listColumn,children:re()}),e.jsxs("form",{className:i.Admin__detailPanel,onSubmit:te,children:[e.jsxs("div",{className:i.Admin__formGrid,children:[e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Название"}),e.jsx("input",{className:i.Admin__input,value:c.name,onChange:s=>l(n=>({...n,name:s.target.value})),placeholder:"Название товара",required:!0})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Категория"}),e.jsx("input",{className:i.Admin__input,value:c.category,onChange:s=>l(n=>({...n,category:s.target.value})),placeholder:"Наименование категории"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Страна"}),e.jsx("input",{className:i.Admin__input,value:c.country,onChange:s=>l(n=>({...n,country:s.target.value})),placeholder:"Производитель / страна"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Ссылка"}),e.jsx("input",{className:i.Admin__input,value:c.href,onChange:s=>l(n=>({...n,href:s.target.value})),placeholder:"#"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Цена (₽)"}),e.jsx("input",{type:"number",className:i.Admin__input,value:c.price,onChange:s=>l(n=>({...n,price:s.target.value})),min:"0",step:"10"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Скидка (₽)"}),e.jsx("input",{type:"number",className:i.Admin__input,value:c.discount,onChange:s=>l(n=>({...n,discount:s.target.value})),min:"0",step:"10"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Рейтинг"}),e.jsx("input",{type:"number",className:i.Admin__input,value:c.rate,onChange:s=>l(n=>({...n,rate:s.target.value})),min:"0",step:"0.1"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Отзывы"}),e.jsx("input",{type:"number",className:i.Admin__input,value:c.commentsSum,onChange:s=>l(n=>({...n,commentsSum:s.target.value})),min:"0"})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Ссылка на изображение"}),e.jsx("input",{className:i.Admin__input,value:c.imgUrl,onChange:s=>l(n=>({...n,imgUrl:s.target.value})),placeholder:"/images/goods/1/image.webp"})]}),e.jsxs("div",{className:i.Admin__uploadRow,children:[e.jsx("label",{className:i.Admin__label,children:"Или загрузите файл"}),e.jsx("input",{type:"file",accept:"image/*",className:i.Admin__fileInput,onChange:s=>R(s.target.files?s.target.files[0]:null,"goods")}),T?e.jsx("p",{className:`${i.Admin__uploadFeedback} ${i[`Admin__uploadFeedback--${T.state}`]}`,children:T.message}):null]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Описание"}),e.jsx("textarea",{className:i.Admin__textarea,value:c.description,onChange:s=>l(n=>({...n,description:s.target.value})),rows:3,placeholder:"Описание товара, которое появится в модальном окне"})]})]}),e.jsx("div",{className:i.Admin__switchRow,children:e.jsxs("label",{className:i.Admin__label,children:[e.jsx("input",{type:"checkbox",checked:c.isHit,onChange:s=>l(n=>({...n,isHit:s.target.checked}))}),"Позвать ХИТ"]})}),e.jsxs("div",{className:i.Admin__actions,children:[e.jsx("button",{type:"button",className:i.Admin__secondaryButton,onClick:V,children:"Сбросить"}),e.jsx("button",{className:i.Admin__submitButton,type:"submit",children:m?"Сохранить товар":"Добавить товар"})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:i.Admin__sectionTitle,children:"Статьи и публикации"}),e.jsxs("div",{className:i.Admin__panelGrid,children:[e.jsx("div",{className:i.Admin__listColumn,children:oe()}),e.jsxs("form",{className:i.Admin__detailPanel,onSubmit:_e,children:[e.jsxs("div",{className:i.Admin__formGrid,children:[e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Название статьи"}),e.jsx("input",{className:i.Admin__input,value:S.title,onChange:s=>u(n=>({...n,title:s.target.value})),required:!0})]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Ссылка на изображение"}),e.jsx("input",{className:i.Admin__input,value:S.imgUrl,onChange:s=>u(n=>({...n,imgUrl:s.target.value})),placeholder:"/images/articles/1/image.webp"})]}),e.jsxs("div",{className:i.Admin__uploadRow,children:[e.jsx("label",{className:i.Admin__label,children:"Или загрузите файл"}),e.jsx("input",{type:"file",accept:"image/*",className:i.Admin__fileInput,onChange:s=>R(s.target.files?s.target.files[0]:null,"articles")}),F?e.jsx("p",{className:`${i.Admin__uploadFeedback} ${i[`Admin__uploadFeedback--${F.state}`]}`,children:F.message}):null]}),e.jsxs("div",{className:i.Admin__fieldGroup,children:[e.jsx("label",{className:i.Admin__label,children:"Ссылка"}),e.jsx("input",{className:i.Admin__input,value:S.link,onChange:s=>u(n=>({...n,link:s.target.value})),placeholder:"/articles/new"})]})]}),e.jsxs("div",{className:i.Admin__actions,children:[e.jsx("button",{type:"button",className:i.Admin__secondaryButton,onClick:M,children:"Сбросить"}),e.jsx("button",{className:i.Admin__submitButton,type:"submit",children:r?"Сохранить статью":"Создать статью"})]})]})]})]})]})]})]}):e.jsx("section",{className:i.Admin__loginPanel,children:e.jsxs("div",{className:i.Admin__loginCard,children:[e.jsx("p",{className:i.Admin__eyebrow,children:"Административный доступ"}),e.jsx("h1",{className:i.Admin__loginTitle,children:"Введите секретный код"}),e.jsx("p",{className:i.Admin__loginDescription,children:"После подтверждения вы получите доступ к рабочим карточкам управления товарным каталогом и блогом."}),e.jsxs("form",{className:i.Admin__loginForm,onSubmit:ae,children:[e.jsx("label",{className:i.Admin__label,htmlFor:"admin-code",children:"Секретный код"}),e.jsx("input",{id:"admin-code",className:i.Admin__input,type:"password",value:p,onChange:s=>D(s.target.value),placeholder:"Введите код доступа"}),e.jsx("button",{className:i.Admin__submitButton,type:"submit",children:"Подтвердить"}),E?e.jsx("p",{className:i.Admin__status,children:E}):null]})]})})})})});_.useEffect(()=>{var w,p;(w=seoQuery.data)!=null&&w.text&&setCustomSidebarText(seoQuery.data.text),(p=seoQuery.data)!=null&&p.imgUrl&&!customSidebarImage&&setCustomSidebarImage(seoQuery.data.imgUrl)},[seoQuery.data,customSidebarImage]);export{Ni as default};
